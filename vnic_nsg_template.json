{
   "contentVersion":"1.0.0.0",
   "resources":[
      {
         "properties":{ },
         "type":"Microsoft.Network/applicationSecurityGroups",
         "location":"[resourceGroup().location]",
         "name":"client_asg",
         "apiVersion":"2017-10-01"
      },
      {
         "properties":{ },
         "type":"Microsoft.Network/applicationSecurityGroups",
         "location":"[resourceGroup().location]",
         "name":"server_asg",
         "apiVersion":"2017-10-01"
      },
      {
         "properties":{
            "securityRules":[
               {
                  "properties":{
                     "description":"denySandboxTraffic",
                     "protocol":"*",
                     "destinationPortRange":"*",
                     "destinationAddressPrefix":"*",
                     "sourceAddressPrefix":"*",
                     "sourcePortRange":"*",
                     "access":"Deny",
                     "direction":"Inbound",
                     "priority":4080
                  },
                  "name":"denyAllTraffic"
               },
               {
                  "properties":{
                     "description":"client_can_ping_server",
                     "protocol":"ICMP",
                     "sourcePortRange":"*",
                     "access":"Allow",
                     "direction":"Inbound",
                     "priority":100,
                     "destinationPortRange":"*",
                     "destinationApplicationSecurityGroups":[
                        {
                           "id":"[resourceId(Microsoft.Network/applicationSecurityGroups/','server_asg')]"
                        }
                     ],
                     "sourceApplicationSecurityGroups":[
                        {
                           "id":"[resourceId(Microsoft.Network/applicationSecurityGroups/','client_asg')]"
                        }
                     ]
                  },
                  "name":"all_apps_to_sidecar"
               }
            ]
         },
         "type":"Microsoft.Network/networkSecurityGroups",
         "location":"[resourceGroup().location]",
         "name":"server_security_group",
         "apiVersion":"2017-10-01",
         "dependsOn":[
            "[resourceId('Microsoft.Network/applicationSecurityGroups/','client_asg')]",
            "[resourceId('Microsoft.Network/applicationSecurityGroups/','server_asg')]"
         ]
      },
      {
         "properties":{
            "securityRules":[
               {
                  "properties":{
                     "description":"denySandboxTraffic",
                     "protocol":"*",
                     "destinationPortRange":"*",
                     "destinationAddressPrefix":"*",
                     "sourceAddressPrefix":"*",
                     "sourcePortRange":"*",
                     "access":"Deny",
                     "direction":"Inbound",
                     "priority":4080
                  },
                  "name":"denyAllTraffic"
               },
               {
                  "properties":{
                     "protocol":"Tcp",
                     "sourcePortRange":"*",
                     "access":"Allow",
                     "direction":"Inbound",
                     "priority":130,
                     "destinationPortRanges":[
                        "3000"
                     ],
                     "destinationApplicationSecurityGroups":[
                        {
                           "id":"[resourceId('Microsoft.Network/applicationSecurityGroups/','client_asg')]"
                        }
                     ],
                     "sourceAddressPrefix":"[reference(resourceId('Microsoft.Network/virtualNetworks/subnets', 'vnet', 'ag_subnet'), '2017-10-01').addressPrefix]"
                  },
                  "name":"ag_can_access_client"
               }
            ]
         },
         "type":"Microsoft.Network/networkSecurityGroups",
         "location":"[resourceGroup().location]",
         "name":"app_shared_security_group",
         "apiVersion":"2017-10-01",
         "dependsOn":[
            "[resourceId('Microsoft.Network/applicationSecurityGroups/','client_asg')]"
         ]
      },
      {
         "properties":{
            "ipConfigurations":[
               {
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "subnet":{
                        "id":"[resourceId('Microsoft.Network/virtualNetworks/subnets', 'vnet', 'app_subnet')]"
                     },
                     "applicationSecurityGroups":[
                        {
                           "id":"[resourceId('Microsoft.Network/applicationSecurityGroups/','client_asg')]"
                        }
                     ]
                  },
                  "name":"client_nicIPConf"
               }
            ],
            "networkSecurityGroup":{
               "id":"[resourceId('Microsoft.Network/networkSecurityGroups/','app_shared_security_group')]"
            }
         },
         "type":"Microsoft.Network/networkInterfaces",
         "dependsOn":[
            "[resourceId('Microsoft.Network/networkSecurityGroups/','app_shared_security_group')]",
            "[resourceId('Microsoft.Network/applicationSecurityGroups/','client_asg')]"
         ],
         "location":"[resourceGroup().location]",
         "name":"client_nic",
         "apiVersion":"2017-10-01"
      },
      {
         "properties":{
            "ipConfigurations":[
               {
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "subnet":{
                        "id":"[resourceId('Microsoft.Network/virtualNetworks/subnets', 'vnet', 'mng_subnet')]"
                     },
                     "applicationSecurityGroups":[
                        {
                           "id":"[resourceId('Microsoft.Network/applicationSecurityGroups/','server_asg')]"
                        }
                     ]
                  },
                  "name":"server_nicIPConf"
               }
            ],
            "networkSecurityGroup":{
               "id":"[resourceId('Microsoft.Network/networkSecurityGroups/','server_security_group')]"
            }
         },
         "type":"Microsoft.Network/networkInterfaces",
         "dependsOn":[
            "[resourceId('Microsoft.Network/networkSecurityGroups/','server_security_group')]",
            "[resourceId('Microsoft.Network/applicationSecurityGroups/','server_asg')]"
         ],
         "location":"[resourceGroup().location]",
         "name":"server_nic",
         "apiVersion":"2017-10-01"
      }
   ],
   "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json"
}
